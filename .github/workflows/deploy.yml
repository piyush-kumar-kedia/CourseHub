name: Deploy CourseHub to EC2

on:
    push:
        branches:
            - master

jobs:
    deploy:
        name: Deploy on Push to Master
        runs-on: ubuntu-latest

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Add SSH Private Key
              run: |
                  echo "${{ secrets.EC2_KEY }}" > private_key.pem
                  chmod 600 private_key.pem

            - name: SSH - Pull Latest Code
              run: |
                  ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
                    set -e
                    echo "ðŸ“¦ Pulling latest code..."
                    cd ~/CourseHub
                    git reset --hard HEAD
                    git clean -fd
                    git pull origin master
                  EOF

            - name: SSH - Update Config Files
              run: |
                  ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << EOF
                    set -e
                    echo "ðŸ” Updating env and token files..."

                    cd ~/CourseHub/server

                    echo "${{ secrets.ENV_FILE }}" > .env
                    echo "${{ secrets.ONEDRIVE_REFRESH_TOKEN }}" > onedrive-refresh-token.token
                    echo "${{ secrets.ONEDRIVE_ACCESS_TOKEN }}" > onedrive-access-token.token
                    echo "${{ secrets.ONEDRIVE_DEVICE_CODE }}" > onedrive-device-code.token
                    
                    echo "${{ secrets.LINKS_JS_FILE }}" > links.js

                    cd ~/CourseHub/client/src/api
                    echo "${{ secrets.SERVER_JS_FILE }}" > server.js
                    cd ~/CourseHub/admin/src/apis
                    echo "${{ secrets.ADMIN_SERVER_JS_FILE }}" > server.js
                  EOF

            - name: SSH - Build Frontend
              run: |
                  ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
                    set -e
                    echo "ðŸ§± Installing and building frontend..."
                    cd ~/CourseHub/client
                    npm install
                    npm run build
                  EOF

            - name: SSH - Setup Server Static Files
              run: |
                  ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
                    set -e
                    echo "ðŸ“± Setting up server static files..."
                    cd ~/CourseHub/server
                    
                    # Create/clear static directory
                    mkdir -p static
                    rm -rf static/*
                    
                    # Copy built files to server static directory
                    cp -r ~/CourseHub/client/dist/* static/
                    
                    # For now, use same file for mobile (you can customize this later)
                    cp static/index.html static/mobile.html
                    
                    echo "âœ… Server static files ready"
                  EOF

            - name: SSH - Backup and Deploy Frontend
              if: success()
              run: |
                  ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
                    set -e
                    sudo mkdir -p /usr/share/nginx/html
                    echo "ðŸ—‚ï¸ Backing up old frontend..."
                    timestamp=$(date +%Y%m%d-%H%M%S)
                    sudo mkdir -p /usr/share/nginx/html-backup
                    if [ -d "/usr/share/nginx/html" ] && [ "$(ls -A /usr/share/nginx/html)" ]; then
                       sudo cp -r /usr/share/nginx/html /usr/share/nginx/html-backup/html-$timestamp
                    fi

                    echo "ðŸš€ Deploying new frontend..."
                    sudo rm -rf /usr/share/nginx/html/*
                    sudo cp -r ~/CourseHub/client/dist/* /usr/share/nginx/html/

                    echo "ðŸ§¹ Cleaning up older backups..."
                    cd /usr/share/nginx/html-backup
                    ls -1tr | head -n -1 | xargs -r -d '\n' sudo rm -rf --
                  EOF

            - name: Rollback Frontend on Failure
              if: failure()
              run: |
                  ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
                    echo "âš ï¸ Build failed. Restoring frontend backup..."
                    latest_backup=$(ls -1tr /usr/share/nginx/html-backup 2>/dev/null | tail -n 1 || true )
                    if [ -n "$latest_backup" ] && [ -d "/usr/share/nginx/html-backup/$latest_backup" ] && [ "$(ls -A /usr/share/nginx/html-backup/$latest_backup 2>/dev/null)" ]; then
                      echo "âœ… Found backup: $latest_backup. Restoring..."
                      sudo mkdir -p /usr/share/nginx/html
                      sudo rm -rf /usr/share/nginx/html/*
                      sudo cp -r /usr/share/nginx/html-backup/$latest_backup/* /usr/share/nginx/html/
                    fi
                    
                    # Also restore server static files backup if it exists
                    cd ~/CourseHub/server
                    if [ -d "static-backup" ] && [ "$(ls -A static-backup)" ]; then
                      echo "âœ… Restoring server static files backup..."
                      rm -rf static/*
                      cp -r static-backup/* static/
                    fi
                  EOF

            - name: SSH - Build Admin Frontend
              run: |
                  ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
                    set -e
                    echo "ðŸ§± Installing and building admin frontend..."
                    cd ~/CourseHub/admin
                    npm install
                    npm run build
                  EOF

            - name: SSH - Backup and Deploy Admin Frontend
              if: success()
              run: |
                  ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
                    set -e
                    sudo mkdir -p /usr/share/nginx/html/admin
                    echo "ðŸ—‚ï¸ Backing up old admin frontend..."
                    timestamp=$(date +%Y%m%d-%H%M%S)
                    sudo mkdir -p /usr/share/nginx/html/admin-backup
                    if [ -d "/usr/share/nginx/html/admin" ] && [ "$(ls -A /usr/share/nginx/html/admin)" ]; then
                       sudo cp -r /usr/share/nginx/html/admin /usr/share/nginx/html/admin-backup/html-$timestamp
                    fi

                    echo "ðŸš€ Deploying new admin frontend..."
                    sudo rm -rf /usr/share/nginx/html/admin/*
                    sudo cp -r ~/CourseHub/admin/dist/* /usr/share/nginx/html/admin/

                    echo "ðŸ§¹ Cleaning up older admin backups..."
                    cd /usr/share/nginx/html/admin-backup
                    ls -1tr | head -n -1 | xargs -r -d '\n' sudo rm -rf --
                  EOF

            - name: Rollback Admin Frontend on Failure
              if: failure()
              run: |
                  ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
                    echo "âš ï¸ Admin build failed. Restoring admin backup..."
                    latest_backup=$(ls -1tr /usr/share/nginx/html/admin-backup 2>/dev/null | tail -n 1 || true )
                    if [ -n "$latest_backup" ] && [ -d "/usr/share/nginx/html/admin-backup/$latest_backup" ] && [ "$(ls -A /usr/share/nginx/html/admin-backup/$latest_backup 2>/dev/null)" ]; then
                      echo "âœ… Found backup: $latest_backup. Restoring..."
                      sudo mkdir -p /usr/share/nginx/html/admin
                      sudo rm -rf /usr/share/nginx/html/admin/*
                      sudo cp -r /usr/share/nginx/html/admin-backup/$latest_backup/* /usr/share/nginx/html/admin/
                    fi
                  EOF

            - name: SSH - Install Server Dependencies and Restart Backend
              run: |
                  ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
                    set -e
                    echo "ðŸ“¦ Installing server dependencies..."
                    cd ~/CourseHub/server
                    npm install
                    
                    echo "ðŸ”„ Restarting server with PM2..."
                    pm2 delete server || true
                    pm2 start index.js --name server
                    pm2 save
                    
                    # Wait a moment for server to start
                    sleep 3
                    
                    # Check if server is running
                    if pm2 list | grep -q "server.*online"; then
                      echo "âœ… Server started successfully"
                    else
                      echo "âŒ Server failed to start"
                      pm2 logs server --lines 10
                      exit 1
                    fi
                  EOF

            - name: SSH - Test and Reload Nginx
              run: |
                  ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
                    set -e
                    echo "ðŸ§ª Testing nginx configuration..."
                    sudo nginx -t

                    echo "â™»ï¸ Reloading nginx..."
                    sudo systemctl reload nginx
                    
                    echo "ðŸ” Checking nginx status..."
                    sudo systemctl is-active nginx
                  EOF

            - name: SSH - Verify Deployment
              run: |
                  ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
                    echo "ðŸ” Verifying deployment..."
                    
                    # Check if static files exist
                    if [ -f "~/CourseHub/server/static/index.html" ] && [ -f "~/CourseHub/server/static/mobile.html" ]; then
                      echo "âœ… Server static files are present"
                    else
                      echo "âŒ Server static files are missing"
                    fi
                    
                    # Check if nginx files exist
                    if [ -f "/usr/share/nginx/html/index.html" ]; then
                      echo "âœ… Nginx frontend files are present"
                    else
                      echo "âŒ Nginx frontend files are missing"
                    fi
                    
                    # Check if admin files exist
                    if [ -f "/usr/share/nginx/html/admin/index.html" ]; then
                      echo "âœ… Admin frontend files are present"
                    else
                      echo "âŒ Admin frontend files are missing"
                    fi
                    
                    # Check PM2 status
                    echo "ðŸ“Š PM2 Status:"
                    pm2 list
                    
                    echo "ðŸŽ‰ Deployment verification complete!"
                  EOF

            - name: Cleanup SSH Key
              if: always()
              run: rm -f private_key.pem
